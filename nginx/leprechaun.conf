upstream img_resize {
	server 0.0.0.0:81;
}

proxy_cache_path /tmp/nginx-images-cache/ levels=1:2 keys_zone=images:10m inactive=24h max_size=100m;

server {
	listen 0.0.0.0:80;

	location / {
		proxy_pass http://leprechaun_client;
		proxy_redirect off;
	}

	# location /admin {
	# 	# auth_basic "Restricted";
    # 	# auth_basic_user_file /etc/nginx/.http_auth;
	# 	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # 	proxy_set_header Host $http_host;
	# 	rewrite ^ http://$host/home break;
	# 	proxy_pass http://leprechaun_admin/ ;
	# 	proxy_redirect off;
	# }

	location /api {
		proxy_pass http://leprechaun_server;
		proxy_redirect off;
	}

	location /docs {
		proxy_pass http://leprechaun_server;
		proxy_redirect off;
	}

	location /img/ {
		location ~ /(.+)/(400|1024|1920)$ {
			proxy_pass http://img_resize;
			proxy_cache images;
			proxy_cache_valid 200 24h;
		}

		location /img/ {
			try_files $uri =404;
			alias /var/www/img/;
			include /etc/nginx/mime.types;
			sendfile on;
			tcp_nopush on;
			tcp_nodelay on;
			expires 1y;
			add_header Pragma public;
			add_header Cache-Control "public";
			fastcgi_hide_header Set-Cookie;
			# limit_rate 196K;
			autoindex off;
		}
	}
}

server {
	listen 0.0.0.0:81;

	location ~ ^/img/(?<image>.+)/(?<width>\d+)$ {
    	alias /var/www/img/$image;
    	image_filter resize $width -;
    	image_filter_jpeg_quality 80;
    	image_filter_buffer 5M;
  	}
}
