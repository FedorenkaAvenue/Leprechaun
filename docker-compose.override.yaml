version: '3.8'

services:
  postgres:
    container_name: leprechaun_postgres
    build: ./postgres
    ports:
      - ${POSTGRES_PORT}:${POSTGRES_PORT}
    environment:
      - POSTGRES_PASSWORD
      - POSTGRES_USER
      - POSTGRES_DATABASE

  server:
    container_name: leprechaun_server
    environment:
      - APP_NAME
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_PASSWORD
      - POSTGRES_USER
      - POSTGRES_DATABASE
      - HOSTING_PATH
    volumes:
      - image_hosting:/var/www/img:rw

  sphinx:
    image: macbre/sphinxsearch:3.2.1
    container_name: leprechaun_sphinx
    #command: indexer --all --config /opt/sphinx/conf/sphinx.conf
    ports:
      - ${SPHINX_PORT}:${SPHINX_PORT}
    volumes:
      - ./sphinx/index:/opt/sphinx/index:rw
      - ./sphinx/sphinx.conf:/opt/sphinx/conf/sphinx.conf
      - ./sphinx/log:/opt/sphinx/log:rw
    depends_on:
      - postgres

  client:
    container_name: leprechaun_client
    environment:
      - APP_NAME

  nginx:
    container_name: leprechaun_nginx
    build:
      context: ./nginx
      dockerfile: Dockerfile
      args:
        - HOSTING_PATH
    depends_on:
      - admin
      - server
      - client
    volumes:
      - image_hosting:/var/www/img:rw
      - ./nginx/.http_auth:/etc/nginx/.http_auth

  admin:
    container_name: leprechaun_admin
    environment:
      - APP_NAME

volumes:
  image_hosting:
